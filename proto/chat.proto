syntax = "proto3";

package chat;

option go_package = "socialnet/services/chat/gen;chatpb";

import "google/api/annotations.proto";
import "auth.proto";

// ==========================
//  Chat Service Definition
// ==========================

service ChatService {
  // --- –°–æ–∑–¥–∞—Ç—å —á–∞—Ç (1-–Ω–∞-1 –∏–ª–∏ –≥—Ä—É–ø–ø–æ–≤–æ–π) ---
  rpc CreateChat(CreateChatRequest) returns (Chat) {
    option (google.api.http) = {
      post: "/api/v1/chats"
      body: "*"
    };
  }

  // --- –ü–æ–ª—É—á–∏—Ç—å —á–∞—Ç –ø–æ ID ---
  rpc GetChat(GetChatRequest) returns (Chat) {
    option (google.api.http) = {
      get: "/api/v1/chats/{id}"
    };
  }

  // --- –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ---
  rpc ListChats(EmptyRequest) returns (Chats) {
    option (google.api.http) = {
      get: "/api/v1/chats"
    };
  }

  // --- –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ ---
  rpc SendMessage(SendMessageRequest) returns (Message) {
    option (google.api.http) = {
      post: "/api/v1/chats/{chat_id}/messages"
      body: "*"
    };
  }

  // --- –ü–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π ---
  rpc ListMessages(ListMessagesRequest) returns (Messages) {
    option (google.api.http) = {
      get: "/api/v1/chats/{chat_id}/messages"
    };
  }

  // --- –£–¥–∞–ª–∏—Ç—å —á–∞—Ç (–µ—Å–ª–∏ –≤–ª–∞–¥–µ–ª–µ—Ü) ---
  rpc DeleteChat(DeleteChatRequest) returns (auth.Confirmation) {
    option (google.api.http) = {
      delete: "/api/v1/chats/{id}"
    };
  }

  // ===========================
  //  –†–µ–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è (—Å—Ç—Ä–∏–º)
  // ===========================

  // üîπ gRPC streaming –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏:
  // –ö–ª–∏–µ–Ω—Ç –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∏ —Å–ª—É—à–∞–µ—Ç –≤—Ö–æ–¥—è—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–∏ –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å).
  rpc ChatStream(stream ChatMessage) returns (stream ChatMessage);

  // üîπ –ü–æ–¥–ø–∏—Å–∫–∞ —Ç–æ–ª—å–∫–æ –Ω–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ —Ñ—Ä–æ–Ω—Ç —Å–ª—É—à–∞–µ—Ç)
  rpc SubscribeMessages(SubscribeRequest) returns (stream Message);

  // üîπ –û—Ç–º–µ—Ç–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ
  rpc MarkAsRead(MarkAsReadRequest) returns (auth.Confirmation) {
    option (google.api.http) = {
      post: "/api/v1/chats/{chat_id}/messages/{message_id}/read"
      body: "*"
    };
  }
}

// ==========================
//  Models
// ==========================

message Chat {
  string id = 1;
  string name = 2;                      // –Ω–∞–∑–≤–∞–Ω–∏–µ (–µ—Å–ª–∏ –≥—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç)
  repeated string participants = 3;     // ID —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
  string last_message = 4;
  string last_sender_id = 5;
  string last_message_time = 6;
  bool is_group = 7;
  string created_at = 8;
  string updated_at = 9;
}

message Chats {
  repeated Chat chats = 1;
}

message Message {
  string id = 1;
  string chat_id = 2;
  string sender_id = 3;
  string content = 4;
  string content_type = 5; // text, image, file
  string media_url = 6;    // —Å—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–∞–π–ª (–µ—Å–ª–∏ –µ—Å—Ç—å)
  string created_at = 7;
  bool read = 8;
}

message Messages {
  repeated Message messages = 1;
}

// ==========================
// Requests
// ==========================

message CreateChatRequest {
  repeated string participants = 1; // ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
  string name = 2;                  // –µ—Å–ª–∏ –≥—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç
}

message GetChatRequest {
  string id = 1;
}

message DeleteChatRequest {
  string id = 1;
}

message SendMessageRequest {
  string chat_id = 1;
  string content = 2;
  string content_type = 3; // text, image, file
  string media_url = 4;    // –µ—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω —Ñ–∞–π–ª
}

message ListMessagesRequest {
  string chat_id = 1;
  int32 limit = 2;
  int32 offset = 3;
}

message EmptyRequest {}

message SubscribeRequest {
  repeated string chat_ids = 1; // –º–æ–∂–Ω–æ –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ —á–∞—Ç–æ–≤
}

message MarkAsReadRequest {
  string chat_id = 1;
  string message_id = 2;
}

// ==========================
//  Streaming Chat Message
// ==========================

message ChatMessage {
  string chat_id = 1;
  string sender_id = 2;
  string content = 3;
  string content_type = 4;
  string created_at = 5;
}
