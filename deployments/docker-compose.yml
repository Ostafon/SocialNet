version: "3.9"

services:
  # ------------------------------------------------------
  # POSTGRES — единая БД для всех сервисов
  # ------------------------------------------------------
  postgres:
    image: postgres:15
    container_name: socialnet_postgres
    restart: always
    environment:
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: admin
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - socialnet

  # ------------------------------------------------------
  # REDIS
  # ------------------------------------------------------
  redis:
    image: redis:7
    container_name: socialnet_redis
    restart: always
    ports:
      - "6379:6379"
    networks:
      - socialnet

  # ------------------------------------------------------
  # AUTH SERVICE
  # ------------------------------------------------------
  auth:
    build:
      context: ../..
      dockerfile: ../deployments/Dockerfile-go
      args:
        SERVICE: "auth"
    container_name: auth_service
    restart: on-failure
    environment:
      DB_CONN: postgres://admin:admin@postgres:5432/authdb?sslmode=disable
      JWT_SECRET: socialnet_secret
      SMTP_USER: ${SMTP_USER}
      SMTP_PASS: ${SMTP_PASS}
      SMTP_HOST: smtp.gmail.com
    depends_on:
      - postgres
    ports:
      - "50051:50051"
    networks:
      - socialnet

  # ------------------------------------------------------
  # USER SERVICE
  # ------------------------------------------------------
  user:
    build:
      context: ../..
      dockerfile: deployments/Dockerfile-go
      args:
        SERVICE: "user"
    container_name: user_service
    restart: on-failure
    environment:
      DB_CONN: postgres://admin:admin@postgres:5432/userdb?sslmode=disable
    depends_on:
      - postgres
    ports:
      - "50052:50052"
    networks:
      - socialnet

  # ------------------------------------------------------
  # POST SERVICE (использует AWS S3)
  # ------------------------------------------------------
  post:
    build:
      context: ../..
      dockerfile: deployments/Dockerfile-go
      args:
        SERVICE: "post"
    container_name: post_service
    restart: on-failure
    environment:
      DB_CONN: postgres://admin:admin@postgres:5432/postdb?sslmode=disable
      AWS_REGION: eu-north-1
      AWS_BUCKET: socialnet-posts
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
    depends_on:
      - postgres
    ports:
      - "50053:50053"
    networks:
      - socialnet

  # ------------------------------------------------------
  # COMMENT SERVICE
  # ------------------------------------------------------
  comment:
    build:
      context: ../..
      dockerfile: deployments/Dockerfile-go
      args:
        SERVICE: "comment"
    container_name: comment_service
    restart: on-failure
    environment:
      DB_CONN: postgres://admin:admin@postgres:5432/commentdb?sslmode=disable
    depends_on:
      - postgres
    ports:
      - "50054:50054"
    networks:
      - socialnet

  # ------------------------------------------------------
  # LIKE SERVICE
  # ------------------------------------------------------
  like:
    build:
      context: ../..
      dockerfile: deployments/Dockerfile-go
      args:
        SERVICE: "like"
    container_name: like_service
    restart: on-failure
    environment:
      DB_CONN: postgres://admin:admin@postgres:5432/likedb?sslmode=disable
    depends_on:
      - postgres
    ports:
      - "50055:50055"
    networks:
      - socialnet

  # ------------------------------------------------------
  # CHAT SERVICE
  # ------------------------------------------------------
  chat:
    build:
      context: ../..
      dockerfile: deployments/Dockerfile-go
      args:
        SERVICE: "chat"
    container_name: chat_service
    restart: on-failure
    environment:
      DB_CONN: postgres://admin:admin@postgres:5432/chatdb?sslmode=disable
      REDIS_ADDR: redis:6379
    depends_on:
      - postgres
      - redis
    ports:
      - "50056:50056"
    networks:
      - socialnet

  # ------------------------------------------------------
  # NOTIFICATION SERVICE
  # ------------------------------------------------------
  notification:
    build:
      context: ../..
      dockerfile: deployments/Dockerfile-go
      args:
        SERVICE: "notification"
    container_name: notification_service
    restart: on-failure
    environment:
      DB_CONN: postgres://admin:admin@postgres:5432/notificationdb?sslmode=disable
      REDIS_ADDR: redis:6379
    depends_on:
      - postgres
      - redis
    ports:
      - "50057:50057"
    networks:
      - socialnet

  # ------------------------------------------------------
  # SEARCH SERVICE
  # ------------------------------------------------------
  search:
    build:
      context: ../..
      dockerfile: deployments/Dockerfile-go
      args:
        SERVICE: "search"
    container_name: search_service
    restart: on-failure
    environment:
      USER_SERVICE_ADDR: user:50052
      POST_SERVICE_ADDR: post:50053
    depends_on:
      - user
      - post
    ports:
      - "50058:50058"
    networks:
      - socialnet

  # ------------------------------------------------------
  # API GATEWAY
  # ------------------------------------------------------
  gateway:
    build:
      context: ../..
      dockerfile: deployments/Dockerfile-go
      args:
        SERVICE: "gateway"
    container_name: api_gateway
    restart: on-failure
    depends_on:
      - auth
      - user
      - post
      - comment
      - like
      - chat
      - notification
      - search
    ports:
      - "8080:8080"
    networks:
      - socialnet

  # ------------------------------------------------------
  # FRONTEND (Next.js/React + nginx)
  # ------------------------------------------------------
  frontend:
    build:
      context: ../..
      dockerfile: deployments/Dockerfile-frontend
    container_name: frontend_app
    restart: always
    ports:
      - "3000:80"
    networks:
      - socialnet

volumes:
  postgres_data:

networks:
  socialnet:
